\section{Proofs and justification}
Some implementation details require further justification and explanations.

\subsection{Ray intersection with a sphere}
Let us detail the computation of point $I$, the intersection between
a ray and a sphere. The ray has its point $P$ on the local plane
($z_P = 0$).
$I$ is both on the ray trajectory (parametrized by $t$) and on the sphere,
hence \cref{eq:sphere-intersect-just1}.

\begin{equation} \label{eq:sphere-intersect-just1}
\begin{cases}
x^2 + y^2 + (z - R)^2 = R^2 \\
x = x_P + t \cdot l \\
y = y_P + t \cdot m \\
z = t \cdot n
\end{cases}
\end{equation}

By substitution, we obtain \cref{eq:sphere-intersect-just2}.

\begin{equation} \label{eq:sphere-intersect-just2}
\begin{split}
&{x_P}^2 + 2 x_P \cdot t \cdot l + t^2
\cdot l^2 \\
+ &{y_P}^2 + 2 y_P \cdot t \cdot m + t^2
\cdot m^2 \\
+ &t^2 \cdot n^2 - 2 R \cdot t \cdot n + R^2
= R^2 \\
\iff &{x_P}^2 + {y_P}^2 \\
+ & 2 t (x_P \cdot l + y_P \cdot m - n \cdot R) \\
+ & t^2 (l^2 + m^2 + n^2) = 0
\end{split} \end{equation}

Since $\overrightarrow{V}$ is a unit vector, $(l^2 + m^2 + n^2) = 1$.
Hence we have a quadratic equation in $t$, \cref{eq:sphere-intersect-just3}.

\begin{equation} \label{eq:sphere-intersect-just3} \begin{cases}
t^2 + b \cdot t + c = 0 \\
b = 2 (x_P \cdot l + y_P \cdot m - n \cdot R) \\
c = {x_P}^2 + {y_P}^2
\end{cases} \end{equation}

The cases in \cref{eq:sphere-intersect-just4} are distinguished.

\begin{equation} \label{eq:sphere-intersect-just4} \begin{cases}
\Delta = b^2 - 4c & \\
\Delta < 0 & \text{no intersection} \\
\Delta = 0 & \text{one intersection (the ray is tangent to the sphere)} \\
\Delta > 0 & \text{two intersections can be found}
\end{cases} \end{equation}

We discard the case where no intersection is found. We also discard
the tangency case for two reasons. First, numerically, it cannot be checked
rigorously in our framework. Second, we see no application within our scope
that would exhibit this case nominally.

The two intersections are given by \cref{eq:sphere-intersect-just5}.

\begin{equation} \label{eq:sphere-intersect-just5} \begin{cases}
t_1 = \frac{-b + \sqrt{\Delta}}{2} \\
t_2 = \frac{-b - \sqrt{\Delta}}{2}
\end{cases} \end{equation}

We want the intersection to be the one closest to the local plane
(see the justification below), hence with minimal $\abs{z}$
(\cref{eq:sphere-intersect-just6}).

\begin{equation} \label{eq:sphere-intersect-just6} \begin{cases}
t_\textrm{sol} = \underset{t}{\mathrm{argmin}} \abs{t \cdot n} 
               = \underset{t}{\mathrm{argmin}} \abs{t} \\
t = \{ t_1, t_2 \}
\end{cases} \end{equation}

Hence, $t_\textrm{sol}$ is the solution with minimal absolute value.
$\abs{-b \pm \sqrt{\Delta}}$ is minimal iff
$-b$ and $\pm \sqrt{\Delta}$ are opposite in sign. Thus our
solution is \cref{eq:sphere-intersect-just7}.

\begin{equation} \label{eq:sphere-intersect-just7}
t_\textrm{sol} = \frac{-b + \textrm{sign}(b) \cdot \sqrt{\Delta}}{2}
\end{equation}

We can start applying $t_\textrm{sol}$ to the ray trajectory to find
the intersection point.

\begin{equation}
z_I = t_\textrm{sol} \cdot n
\end{equation}

The intersection could have happened in the hemisphere which we do
not want to consider. We consider \cref{eq:sphere-intersect-just8}.

\begin{equation} \label{eq:sphere-intersect-just8}
\begin{cases}
\abs{z_I} < \abs{R} & \text{Intersection in valid hemisphere} \\
\abs{z_I} \geq \abs{R} & \text{Intersection in wrong hemisphere}
\end{cases}
\end{equation}

We then assign an error case to $\abs{z_I} \geq \abs{R}$. If the intersection
is in the right hemisphere however, we can continue by computing
the remaining point coordinates \cref{eq:sphere-intersect-just9}.

\begin{equation} \label{eq:sphere-intersect-just9}
\begin{cases}
x_I &= x + t_\textrm{sol} \cdot l \\
y_I &= y + t_\textrm{sol} \cdot m
\end{cases} \end{equation}

$\square$

\paragraph{Intersection selection rationale}
\label{sec:sphere-intersection-selection}

We explain why we select the intersection solution that is closest to
the local plane. Notably, we do not want necessarily the \emph{first}
intersection with the hemisphere encountered by the ray in its propagation.

The hemisphere is defined as either \emph{concave} or \emph{convex} by its
radius and by the orientation of incoming rays. This determines
the intended optical interaction of the ray with the surface.  For instance, a
\emph{concave} mirror applies a converging optical power to incoming rays. All
the cases are listed in \cref{tab:sphere-definition-cases}.

\begin{table} \caption{\label{tab:sphere-definition-cases} Intended sphere
shape as seen by incoming rays.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$ & $n > 0$ \\ \hline
$R < 0$ & convex  & concave \\ \hline
$R > 0$ & concave & convex  \\
\hline \end{tabular} \end{table}

A ray at one of its two eventual points of intersection with a sphere can be
said to either \emph{exit} or \emph{enter} the sphere, along its own
propagation direction. The shape of the sphere as seen by the oriented incoming
ray is determined by the alternative between \emph{exitting} and
\emph{entering}.  The rays incoming onto a \emph{concave} sphere must intersect
the sphere at the point they are \emph{exitting} the sphere.  Conversely, the
rays incoming onto a \emph{convex} sphere must intersect the sphere at the
point they are \emph{entering} the sphere.

Consider that: \begin{itemize}
\item Out of the two eventual intersection points, one is \emph{exitting},
the other is \emph{entering}.
\item The ray, along its propagation, must first \emph{enter} the sphere
      and then \emph{exit}.
\item For the \emph{convex} (or \emph{entering}) case, the entrance
happens closest to the local plane.
\item For the \emph{concave} (or \emph{exitting}) case, the exit
happens closest to the local plane.
\end{itemize}

Hence, the intersection point we need is always the one closest to the
local plane\footnote{Admittedly, this justification is confuse. Please
review all cases on a diagram and you can convince yourself.}.

\paragraph{b = 0 case}

\textcolor{red}{TODO:
1. What about b = 0 case? Document (already solved in notes).
2. Put a diagram for defining the quantities (placing I etc.)
3. Illustrate the error cases with diagrams.
4. Show orientation of ray has no impact on intersection.}

