\section{Proofs and justification}
\label{sec:justification}

Some implementation details require further justification and explanations.

\subsection{Ray intersection with a sphere}
Let us detail the computation of point $I$, the intersection between
a ray and a sphere. The ray has its point $P$ on the local plane
($z_P = 0$).
$I$ is both on the ray trajectory (parametrized by $t$) and on the sphere,
hence \cref{eq:sphere-intersect-just1}.

\begin{equation} \label{eq:sphere-intersect-just1}
\begin{cases}
x^2 + y^2 + (z - R)^2 = R^2 \\
x = x_P + t \cdot l \\
y = y_P + t \cdot m \\
z = t \cdot n
\end{cases}
\end{equation}

By substitution, we obtain \cref{eq:sphere-intersect-just2}.

\begin{equation} \label{eq:sphere-intersect-just2}
\begin{split}
&{x_P}^2 + 2 x_P \cdot t \cdot l + t^2
\cdot l^2 \\
+ &{y_P}^2 + 2 y_P \cdot t \cdot m + t^2
\cdot m^2 \\
+ &t^2 \cdot n^2 - 2 R \cdot t \cdot n + R^2
= R^2 \\
\iff &{x_P}^2 + {y_P}^2 \\
+ & 2 t (x_P \cdot l + y_P \cdot m - n \cdot R) \\
+ & t^2 (l^2 + m^2 + n^2) = 0
\end{split} \end{equation}

Since $\overrightarrow{V}$ is a unit vector, $(l^2 + m^2 + n^2) = 1$.
Hence we have a quadratic equation in $t$, \cref{eq:sphere-intersect-just3}.

\begin{equation} \label{eq:sphere-intersect-just3} \begin{cases}
t^2 + b \cdot t + c = 0 \\
b = 2 (x_P \cdot l + y_P \cdot m - n \cdot R) \\
c = {x_P}^2 + {y_P}^2
\end{cases} \end{equation}

The cases in \cref{eq:sphere-intersect-just4} are distinguished.

\begin{equation} \label{eq:sphere-intersect-just4} \begin{cases}
\Delta = b^2 - 4c & \\
\Delta < 0 & \text{no intersection} \\
\Delta = 0 & \text{one intersection (the ray is tangent to the sphere)} \\
\Delta > 0 & \text{two intersections can be found}
\end{cases} \end{equation}

We discard the case where no intersection is found. We also discard
the tangency case for two reasons. First, numerically, it cannot be checked
rigorously in our framework. Second, we see no application within our scope
that would exhibit this case nominally. These discarded cases are illustrated
in \cref{fig:sphere-inter-delta}.

\begin{figure} \caption{\label{fig:sphere-inter-delta} Sphere intersection
error cases on the sign of $\Delta$.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/sphere-rayinter-errorcase-delta.svg}
\end{figure}

The two intersections are given by \cref{eq:sphere-intersect-just5}.

\begin{equation} \label{eq:sphere-intersect-just5} \begin{cases}
t_1 = \frac{-b + \sqrt{\Delta}}{2} \\
t_2 = \frac{-b - \sqrt{\Delta}}{2}
\end{cases} \end{equation}

We want the intersection to be the one closest to the local plane
(see the justification below), hence with minimal $\abs{z}$
(\cref{eq:sphere-intersect-just6}).

\begin{equation} \label{eq:sphere-intersect-just6} \begin{cases}
t_\textrm{sol} = \underset{t}{\mathrm{argmin}} \abs{t \cdot n} 
               = \underset{t}{\mathrm{argmin}} \abs{t} \\
t = \{ t_1, t_2 \}
\end{cases} \end{equation}

Hence, $t_\textrm{sol}$ is the solution with minimal absolute value.
$\abs{-b \pm \sqrt{\Delta}}$ is minimal iff
$-b$ and $\pm \sqrt{\Delta}$ are opposite in sign. Thus our
solution is \cref{eq:sphere-intersect-just7}.

\begin{equation} \label{eq:sphere-intersect-just7}
t_\textrm{sol} = \frac{-b + \textrm{sign}(b) \cdot \sqrt{\Delta}}{2}
\end{equation}

We can start applying $t_\textrm{sol}$ to the ray trajectory to find
the intersection point.

\begin{equation}
z_I = t_\textrm{sol} \cdot n
\end{equation}

The intersection could have happened in the hemisphere which we do
not want to consider. We consider \cref{eq:sphere-intersect-just8}.

\begin{equation} \label{eq:sphere-intersect-just8}
\begin{cases}
\abs{z_I} < \abs{R} & \text{Intersection in valid hemisphere} \\
\abs{z_I} \geq \abs{R} & \text{Intersection in wrong hemisphere}
\end{cases}
\end{equation}

We then assign an error case to $\abs{z_I} \geq \abs{R}$
(\cref{fig:sphere-inter-error-zi}).  If the intersection is in the right
hemisphere however, we can continue by computing the remaining point
coordinates \cref{eq:sphere-intersect-just9}.

\begin{equation} \label{eq:sphere-intersect-just9}
\begin{cases}
x_I &= x + t_\textrm{sol} \cdot l \\
y_I &= y + t_\textrm{sol} \cdot m
\end{cases} \end{equation}

\begin{figure} \caption{\label{fig:sphere-inter-error-zi} Sphere intersection
error case on the hemisphere being intersected.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/sphere-rayinter-errorcase-zi.svg}
\end{figure}

$\square$

\paragraph{Intersection selection rationale}
\label{sec:sphere-intersection-selection}

We explain why we select the intersection solution that is closest to
the local plane. Notably, we do not want necessarily the \emph{first}
intersection with the hemisphere encountered by the ray in its propagation.

The hemisphere is defined as either \emph{concave} or \emph{convex} by its
radius and by the orientation of incoming rays. This determines
the intended optical interaction of the ray with the surface.  For instance, a
\emph{concave} mirror applies a converging optical power to incoming rays. All
the cases are listed in \cref{tab:sphere-definition-cases}.

\begin{table} \caption{\label{tab:sphere-definition-cases} Intended sphere
shape as seen by incoming rays.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$ & $n > 0$ \\ \hline
$R < 0$ & convex  & concave \\ \hline
$R > 0$ & concave & convex  \\
\hline \end{tabular} \end{table}

A ray at one of its two eventual points of intersection with a sphere can be
said to either \emph{exit} or \emph{enter} the sphere, along its own
propagation direction. The shape of the sphere as seen by the oriented incoming
ray is determined by the alternative between \emph{exitting} and
\emph{entering}.  The rays incoming onto a \emph{concave} sphere must intersect
the sphere at the point they are \emph{exitting} the sphere.  Conversely, the
rays incoming onto a \emph{convex} sphere must intersect the sphere at the
point they are \emph{entering} the sphere. \cref{tab:sphere-exit-entrance}
summarizes the intersection point we need.

\begin{table} \caption{\label{tab:sphere-exit-entrance} Intersection point
to compute for each case.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$   & $n > 0$  \\ \hline
$R < 0$ & entrance  & exit     \\ \hline
$R > 0$ & exit      & entrance \\
\hline \end{tabular} \end{table}

Consider that: \begin{itemize}
\item Out of the two eventual intersection points, one is \emph{exitting},
the other is \emph{entering}.
\item The ray, along its propagation (increasing $t$), must first \emph{enter}
the sphere and then \emph{exit}.
\end{itemize}

We note $t_\textrm{en}$ the parameter along the ray trajectory at the sphere
entrance, and $t_\textrm{ex}$ the parameter at the sphere exit. Necessarily,
we have $t_\textrm{ex} > t_\textrm{en}$. Incidentally, this allows assigning
either the entrance or exit to the $t_\textrm{sol}$ parameter
\cref{eq:sphere-intersect-just5}. This is another way of disambiguating the
solution $t_\textrm{sol}$, but we want to prove the solution is closest to the
local plane.

\begin{equation}
\begin{cases}
t_\textrm{ex} &= \frac{-b + \sqrt{\Delta}}{2} \\
t_\textrm{en} &= \frac{-b - \sqrt{\Delta}}{2}
\end{cases}
\end{equation}

The intersection point happens at $z = t \cdot n$, in each case we can
determine the order between $z_\textrm{ex} = t_\textrm{ex} \cdot n$ and
$z_\textrm{en} = t_\textrm{en} \cdot n$.

\begin{itemize}
\item $n>0$: $z_\textrm{ex} > z_\textrm{en}$
\item $n<0$: $z_\textrm{ex} < z_\textrm{en}$
\end{itemize}

By our definition of the sphere, any intersection point $z$ coordinate
has a sign given by the sign of $R$.

\begin{itemize}
\item $R>0$: $z>0$
\item $R<0$: $z<0$
\end{itemize}

Hence we can deduce an order between $\abs{z_\textrm{ex}}$ and
$\abs{z_\textrm{en}}$ depending on the case
(\cref{tab:sphere-intersection-zorder}).

\begin{table} \caption{\label{tab:sphere-intersection-zorder} 
Order in $\abs{z}$ of intersection points.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$   & $n > 0$  \\ \hline
$R < 0$ & $\abs{z_\textrm{en}} < \abs{z_\textrm{ex}}$ &
          $\abs{z_\textrm{en}} > \abs{z_\textrm{ex}}$     \\ \hline
$R > 0$ & $\abs{z_\textrm{en}} > \abs{z_\textrm{ex}}$ &
          $\abs{z_\textrm{en}} < \abs{z_\textrm{ex}}$ \\
\hline \end{tabular} \end{table}

Finally, we can conclude by crossing \cref{tab:sphere-exit-entrance}
and \cref{tab:sphere-intersection-zorder}, that the intersection point
we need to pick is always the one with minimal $\abs{z}$. Hence the
solution we need is always closest to the local plane.\footnote{Admittedly,
this justification is laborious. The reader can convince themselves
that the solution intersection is the one closest to the local plane just
by looking at the diagrams.}

\paragraph{b = 0 case}
Looking at \cref{eq:ray-sphere-inter-tsol}, it may seem numerically
unstable around $b = 0$ due to the term $\textrm{sign}(b) \cdot \sqrt{\Delta}$.

However, at this stage of the computation, we have
\cref{eq:sphere-inter-just10}.

\begin{equation} \label{eq:sphere-inter-just10} \begin{cases}
b^2 &= \Delta + 4 c \\
\Delta &> 0 \\
c &\geq 0
\end{cases} \end{equation}

Hence, $\abs{b}$ can only near zero when both $\Delta$ and $c$ are near zero.
Thus the term $\textrm{sign}(b) \cdot \sqrt{\Delta}$ may be numerically
unstable in sign, but is near zero in this region.

\subsection{General expression for a shape normal vector}
Given a shape in its \gls{LCS} defined by an equation $z = f(x, y)$,
we can compute the unit normal vector at point $(x, y)$ using
\cref{eq:gen-normal} \cite{mathworld:normal-vector}. Additionally
we orient the normal vector in the opposite half-plane to an incident
ray with a vector component $n$.

\begin{equation} \label{eq:gen-normal}
\overrightarrow{N} =
\frac{\textrm{sign}(n)}
     {\sqrt{1 + \left(\frac{\partial f}{\partial x}(x, y)\right)^2 +
                \left(\frac{\partial f}{\partial y}(x, y)\right)^2}}
\cdot
\begin{bmatrix}
\frac{\partial f}{\partial x}(x, y) \\
\frac{\partial f}{\partial y}(x, y) \\
-1
\end{bmatrix}
\end{equation}

\subsection{Sphere altitude formulation and first derivatives}
We formulate the sphere altitude in the $z = f(x, y)$ form. This form
is useful for hand calculations, plots, etc. We follow by deriving the
first derivatives in $x$ and $y$.

\paragraph{altitude}
The complete sphere is described by

\begin{equation}
\begin{split}
& x^2 + y^2 + (z - R)^2 = R^2 \\
\iff & (z - R)^2 = R^2 - x^2 - y^2 \\
\iff & \abs{z-R} = \sqrt{R^2 - x^2 - y^2}
\end{split} \end{equation}

Now, we consider only the first hemisphere $(\abs{z} < \abs{R})$, so
there are two cases depending on the sign of $R$. Moreover, by definition,
the sign of $z$ is the same as that of $R$.

\begin{equation} \begin{cases}
\abs{z - R} = -z + R & R \geq 0 \\
\abs{z - R} = z - R & R < 0
\end{cases} \end{equation}

For the $R \geq 0$ case, we have:

\begin{equation} \begin{split}
& R - z = \sqrt{R^2 -x^2 -y^2} \\
\iff & z = R \left( 1 - \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{split} \end{equation}

For the $R < 0$ case, we have:

\begin{equation} \begin{split}
& z - R = \sqrt{R^2 -x^2 -y^2} \\
\iff & z = R \left( 1 + \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{split} \end{equation}

The two cases can be reunited in the following formula, which is the
analytic expression of the sphere shape in our program \cref{eq:sphere-alt}.

\begin{equation} \label{eq:sphere-alt}
z = R \left( 1 - \textrm{sign}(R) \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{equation}

\paragraph{derivatives}
We compute the partial derivative with respect to $x$ of \cref{eq:sphere-alt}.

\begin{equation} \begin{split}
\frac{\partial z}{\partial x} & = 
\frac{\partial}{\partial x}
\left( -R \cdot \textrm{sign}(R) \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right) \\
& = - \abs{R} \frac{\partial}{\partial x}
\left( \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right) \\
& = \abs{R} \cdot \frac{1}{\sqrt{1 - \frac{x^2 + y^2}{R^2}}} \cdot
\frac{x}{R^2} \\
& = \frac{R \cdot \textrm{sign}(R) \cdot x}{R \sqrt{R^2 - x^2 -y^2}} \\
& = \frac{\textrm{sign}(R) \cdot x}{\sqrt{R^2 - x^2 -y^2}}
\end{split} \end{equation}

By symmetry, we find the partial derivative with respect to $y$, both
formulae are in \cref{eq:sphere-derivatives}.

\begin{equation} \label{eq:sphere-derivatives} \begin{cases}
\frac{\partial z}{\partial x} (x, y) =
\frac{\textrm{sign}(R) \cdot x}{\sqrt{R^2 - x^2 -y^2}} \\
\frac{\partial z}{\partial y} (x, y) =
\frac{\textrm{sign}(R) \cdot y}{\sqrt{R^2 - x^2 -y^2}} \\
\end{cases} \end{equation}

\subsection{Sphere normal vector}
We derive an efficient expression for the normal vector of a sphere at
an intersection point. Keep in mind that we already know the intersection
point on the shape. We arrive at the result from two (slightly) different
starting points.

\subsubsection{Analytic formulation}
We plug the partial derivatives \cref{eq:sphere-derivatives} into the general
normal vector formula \cref{eq:gen-normal}.

\begin{equation} \begin{split}
\overrightarrow{N} & = \frac{\textrm{sign}(n)}
{\sqrt{1 + \frac{x^2}{R^2 - x^2 - y^2} + \frac{y^2}{R^2 - x^2 - y^2}}} \cdot
\begin{bmatrix}
\textrm{sign}(R) \cdot x \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
\textrm{sign}(R) \cdot y \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
-1
\end{bmatrix} \\
& = \frac{\textrm{sign}(n) \cdot \textrm{sign}(R) \cdot
          \sqrt{R^2 - x^2 - y^2}}
         {\sqrt{R^2 - x^2 - y^2 + x^2 + y^2}} \cdot
\begin{bmatrix}
x \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
y \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
-\textrm{sign}(R)
\end{bmatrix} \\
& = \frac{\textrm{sign}(R)}{\abs{R}} \cdot \textrm{sign}(n) \cdot
\begin{bmatrix}
x \\ y \\
- \textrm{sign}(R) \sqrt{R^2 - x^2 - y^2}
\end{bmatrix} \\
& = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix}
x \\ y \\
- \textrm{sign}(R) \sqrt{R^2 - x^2 - y^2}
\end{bmatrix}
\end{split} \end{equation}

With,

\begin{equation} \begin{cases}
\abs{z-R} = R - z & R \geq 0 \\
\abs{z-R} = z - R & R < 0
\end{cases} \end{equation}

Hence,

\begin{equation}
\abs{z-R} \cdot \textrm{sign}(R) = R - z
\end{equation}

Which leads us to the efficient expression for the sphere normal vector
\cref{eq:sphere-normal-anaformula}.

\begin{equation} \label{eq:sphere-normal-anaformula}
\overrightarrow{N} = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix}
x \\ y \\ z - R
\end{bmatrix}
\end{equation}

\subsubsection{Geometric formulation}
The center of the sphere is $C = (0, 0, R)$. We know the intersection point
$I = (x, y, z)$.

The normal vector to the sphere is colinear to $\overrightarrow{CI}$.

\begin{equation}
\overrightarrow{CI} = \begin{bmatrix} x \\ y \\ z - R \end{bmatrix}
\end{equation}

Now we obtain a vector $\overrightarrow{N_i}$ by flipping $\overrightarrow{CI}$
opposite to the incident ray in the $\hat{z}$ direction.

Remember that,

\begin{equation} \begin{cases}
z - R \leq 0 & R \geq 0 \\
z - R > 0 & R < 0
\end{cases} \end{equation}

so we have,

\begin{equation} \begin{cases}
\overrightarrow{N_i} = \textrm{sign}(n) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix} & R \geq 0 \\
\overrightarrow{N_i} = - \textrm{sign}(n) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix} & R < 0 \\
\end{cases} \end{equation}

Which can be summarized as,

\begin{equation}
\overrightarrow{N_i} = \textrm{sign}(n) \cdot \textrm{sign}(R) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix}
\end{equation}

Now, we simply normalize the vector in order to obtain $\overrightarrow{N}$.

\begin{equation} \begin{split}
\overrightarrow{N} &= \frac{\textrm{sign}(n) \cdot \textrm{sign}(R)}
{\sqrt{x^2 + y^2 + (z-R)^2}} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix} \\
&= \frac{\textrm{sign}(n) \cdot \textrm{sign}(R)}{\abs{R}} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix}
\end{split} \end{equation}

The efficient expression for $\overrightarrow{N}$ is given by
\cref{eq:sphere-normal-geoformula}.

\begin{equation} \label{eq:sphere-normal-geoformula}
\overrightarrow{N} = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix}
\end{equation}
