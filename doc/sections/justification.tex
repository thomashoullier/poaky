\section{Proofs and justification}
\label{sec:justification}

Some implementation details require further justification and explanations.

\subsection{Ray intersection with a sphere}
Let us detail the computation of point $I$, the intersection between
a ray and a sphere. The ray has its point $P$ on the local plane
($z_P = 0$).
$I$ is both on the ray trajectory (parametrized by $t$) and on the sphere,
hence \cref{eq:sphere-intersect-just1}.

\begin{equation} \label{eq:sphere-intersect-just1}
\begin{cases}
x^2 + y^2 + (z - R)^2 = R^2 \\
x = x_P + t \cdot l \\
y = y_P + t \cdot m \\
z = t \cdot n
\end{cases}
\end{equation}

By substitution, we obtain \cref{eq:sphere-intersect-just2}.

\begin{equation} \label{eq:sphere-intersect-just2}
\begin{split}
&{x_P}^2 + 2 x_P \cdot t \cdot l + t^2
\cdot l^2 \\
+ &{y_P}^2 + 2 y_P \cdot t \cdot m + t^2
\cdot m^2 \\
+ &t^2 \cdot n^2 - 2 R \cdot t \cdot n + R^2
= R^2 \\
\iff &{x_P}^2 + {y_P}^2 \\
+ & 2 t (x_P \cdot l + y_P \cdot m - n \cdot R) \\
+ & t^2 (l^2 + m^2 + n^2) = 0
\end{split} \end{equation}

Since $\overrightarrow{V}$ is a unit vector, $(l^2 + m^2 + n^2) = 1$.
Hence we have a quadratic equation in $t$, \cref{eq:sphere-intersect-just3}.

\begin{equation} \label{eq:sphere-intersect-just3} \begin{cases}
t^2 + b \cdot t + c = 0 \\
b = 2 (x_P \cdot l + y_P \cdot m - n \cdot R) \\
c = {x_P}^2 + {y_P}^2
\end{cases} \end{equation}

The cases in \cref{eq:sphere-intersect-just4} are distinguished.

\begin{equation} \label{eq:sphere-intersect-just4} \begin{cases}
\Delta = b^2 - 4c & \\
\Delta < 0 & \text{no intersection} \\
\Delta = 0 & \text{one intersection (the ray is tangent to the sphere)} \\
\Delta > 0 & \text{two intersections can be found}
\end{cases} \end{equation}

We discard the case where no intersection is found. We also discard
the tangency case for two reasons. First, numerically, it cannot be checked
rigorously in our framework. Second, we see no application within our scope
that would exhibit this case nominally. These discarded cases are illustrated
in \cref{fig:sphere-inter-delta}.

\begin{figure} \caption{\label{fig:sphere-inter-delta} Sphere intersection
error cases on the sign of $\Delta$.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/sphere-rayinter-errorcase-delta.svg}
\end{figure}

The two intersections are given by \cref{eq:sphere-intersect-just5}.

\begin{equation} \label{eq:sphere-intersect-just5} \begin{cases}
t_1 = \frac{-b + \sqrt{\Delta}}{2} \\
t_2 = \frac{-b - \sqrt{\Delta}}{2}
\end{cases} \end{equation}

We want the intersection to be the one closest to the local plane
(see the justification below), hence with minimal $\abs{z}$
(\cref{eq:sphere-intersect-just6}).

\begin{equation} \label{eq:sphere-intersect-just6} \begin{cases}
t_\textrm{sol} = \underset{t}{\mathrm{argmin}} \abs{t \cdot n} 
               = \underset{t}{\mathrm{argmin}} \abs{t} \\
t = \{ t_1, t_2 \}
\end{cases} \end{equation}

Hence, $t_\textrm{sol}$ is the solution with minimal absolute value.
$\abs{-b \pm \sqrt{\Delta}}$ is minimal iff
$-b$ and $\pm \sqrt{\Delta}$ are opposite in sign. Thus our
solution is \cref{eq:sphere-intersect-just7}.

\begin{equation} \label{eq:sphere-intersect-just7}
t_\textrm{sol} = \frac{-b + \textrm{sign}(b) \cdot \sqrt{\Delta}}{2}
\end{equation}

We can start applying $t_\textrm{sol}$ to the ray trajectory to find
the intersection point.

\begin{equation}
z_I = t_\textrm{sol} \cdot n
\end{equation}

The intersection could have happened in the hemisphere which we do
not want to consider. We consider \cref{eq:sphere-intersect-just8}.

\begin{equation} \label{eq:sphere-intersect-just8}
\begin{cases}
\abs{z_I} < \abs{R} & \text{Intersection in valid hemisphere} \\
\abs{z_I} \geq \abs{R} & \text{Intersection in wrong hemisphere}
\end{cases}
\end{equation}

We then assign an error case to $\abs{z_I} \geq \abs{R}$
(\cref{fig:sphere-inter-error-zi}).  If the intersection is in the right
hemisphere however, we can continue by computing the remaining point
coordinates \cref{eq:sphere-intersect-just9}.

\begin{equation} \label{eq:sphere-intersect-just9}
\begin{cases}
x_I &= x + t_\textrm{sol} \cdot l \\
y_I &= y + t_\textrm{sol} \cdot m
\end{cases} \end{equation}

\begin{figure} \caption{\label{fig:sphere-inter-error-zi} Sphere intersection
error case on the hemisphere being intersected.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/sphere-rayinter-errorcase-zi.svg}
\end{figure}

$\square$

\paragraph{Intersection selection rationale}
\label{sec:sphere-intersection-selection}

We explain why we select the intersection solution that is closest to
the local plane. Notably, we do not want necessarily the \emph{first}
intersection with the hemisphere encountered by the ray in its propagation.

The hemisphere is defined as either \emph{concave} or \emph{convex} by its
radius and by the orientation of incoming rays. This determines
the intended optical interaction of the ray with the surface.  For instance, a
\emph{concave} mirror applies a converging optical power to incoming rays. All
the cases are listed in \cref{tab:sphere-definition-cases}.

\begin{table} \caption{\label{tab:sphere-definition-cases} Intended sphere
shape as seen by incoming rays.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$ & $n > 0$ \\ \hline
$R < 0$ & convex  & concave \\ \hline
$R > 0$ & concave & convex  \\
\hline \end{tabular} \end{table}

A ray at one of its two eventual points of intersection with a sphere can be
said to either \emph{exit} or \emph{enter} the sphere, along its own
propagation direction. The shape of the sphere as seen by the oriented incoming
ray is determined by the alternative between \emph{exitting} and
\emph{entering}.  The rays incoming onto a \emph{concave} sphere must intersect
the sphere at the point they are \emph{exitting} the sphere.  Conversely, the
rays incoming onto a \emph{convex} sphere must intersect the sphere at the
point they are \emph{entering} the sphere. \cref{tab:sphere-exit-entrance}
summarizes the intersection point we need.

\begin{table} \caption{\label{tab:sphere-exit-entrance} Intersection point
to compute for each case.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$   & $n > 0$  \\ \hline
$R < 0$ & entrance  & exit     \\ \hline
$R > 0$ & exit      & entrance \\
\hline \end{tabular} \end{table}

Consider that: \begin{itemize}
\item Out of the two eventual intersection points, one is \emph{exitting},
the other is \emph{entering}.
\item The ray, along its propagation (increasing $t$), must first \emph{enter}
the sphere and then \emph{exit}.
\end{itemize}

We note $t_\textrm{en}$ the parameter along the ray trajectory at the sphere
entrance, and $t_\textrm{ex}$ the parameter at the sphere exit. Necessarily,
we have $t_\textrm{ex} > t_\textrm{en}$. Incidentally, this allows assigning
either the entrance or exit to the $t_\textrm{sol}$ parameter
\cref{eq:sphere-intersect-just5}. This is another way of disambiguating the
solution $t_\textrm{sol}$, but we want to prove the solution is closest to the
local plane.

\begin{equation}
\begin{cases}
t_\textrm{ex} &= \frac{-b + \sqrt{\Delta}}{2} \\
t_\textrm{en} &= \frac{-b - \sqrt{\Delta}}{2}
\end{cases}
\end{equation}

The intersection point happens at $z = t \cdot n$, in each case we can
determine the order between $z_\textrm{ex} = t_\textrm{ex} \cdot n$ and
$z_\textrm{en} = t_\textrm{en} \cdot n$.

\begin{itemize}
\item $n>0$: $z_\textrm{ex} > z_\textrm{en}$
\item $n<0$: $z_\textrm{ex} < z_\textrm{en}$
\end{itemize}

By our definition of the sphere, any intersection point $z$ coordinate
has a sign given by the sign of $R$.

\begin{itemize}
\item $R>0$: $z>0$
\item $R<0$: $z<0$
\end{itemize}

Hence we can deduce an order between $\abs{z_\textrm{ex}}$ and
$\abs{z_\textrm{en}}$ depending on the case
(\cref{tab:sphere-intersection-zorder}).

\begin{table} \caption{\label{tab:sphere-intersection-zorder} 
Order in $\abs{z}$ of intersection points.}
\begin{tabular}{| c | c | c |} \hline
-       & $n < 0$   & $n > 0$  \\ \hline
$R < 0$ & $\abs{z_\textrm{en}} < \abs{z_\textrm{ex}}$ &
          $\abs{z_\textrm{en}} > \abs{z_\textrm{ex}}$     \\ \hline
$R > 0$ & $\abs{z_\textrm{en}} > \abs{z_\textrm{ex}}$ &
          $\abs{z_\textrm{en}} < \abs{z_\textrm{ex}}$ \\
\hline \end{tabular} \end{table}

Finally, we can conclude by crossing \cref{tab:sphere-exit-entrance}
and \cref{tab:sphere-intersection-zorder}, that the intersection point
we need to pick is always the one with minimal $\abs{z}$. Hence the
solution we need is always closest to the local plane.\footnote{Admittedly,
this justification is laborious. The reader can convince themselves
that the solution intersection is the one closest to the local plane just
by looking at the diagrams.}

\paragraph{b = 0 case}
Looking at \cref{eq:ray-sphere-inter-tsol}, it may seem numerically
unstable around $b = 0$ due to the term $\textrm{sign}(b) \cdot \sqrt{\Delta}$.

However, at this stage of the computation, we have
\cref{eq:sphere-inter-just10}.

\begin{equation} \label{eq:sphere-inter-just10} \begin{cases}
b^2 &= \Delta + 4 c \\
\Delta &> 0 \\
c &\geq 0
\end{cases} \end{equation}

Hence, $\abs{b}$ can only near zero when both $\Delta$ and $c$ are near zero.
Thus the term $\textrm{sign}(b) \cdot \sqrt{\Delta}$ may be numerically
unstable in sign, but is near zero in this region.

\subsection{General expression for a shape normal vector}
Given either an explicit formula ($z = f(x, y)$), or an implicit
formula ($F(x, y, z) = 0$) representing a surface, we show how
to compute the unit normal vector at a given point. Additionally
we orient the normal vector in the opposite half-plane to an incident
ray with a vector component $n$.

\subsubsection{From an explicit formula}
Given a shape in its \gls{LCS} defined by an equation $z = f(x, y)$,
we can compute the unit normal vector at point $(x, y)$ using
\cref{eq:gen-normal} \cite{mathworld:normal-vector}. 

\begin{equation} \label{eq:gen-normal}
\overrightarrow{N} =
\frac{\textrm{sign}(n)}
     {\sqrt{1 + \left(\frac{\partial f}{\partial x}(x, y)\right)^2 +
                \left(\frac{\partial f}{\partial y}(x, y)\right)^2}}
\cdot
\begin{bmatrix}
\frac{\partial f}{\partial x}(x, y) \\
\frac{\partial f}{\partial y}(x, y) \\
-1
\end{bmatrix}
\end{equation}

\subsubsection{From an implicit formula}
A normal vector may also be defined using an implicit surface definition of
the form $F(x, y, z) = 0$ (\cite{wiki:normal}, \cite{Welford:1986} section 4.6).
A normal vector at a point on the surface is simply given by the gradient
$\nabla F$ evaluated at this point.

\begin{equation}
\nabla F =
\begin{bmatrix}
\frac{\partial F}{\partial x} \\
\frac{\partial F}{\partial y} \\
\frac{\partial F}{\partial z}
\end{bmatrix}
\end{equation}

Thus the unit normal vector oriented opposite to $n$ is given by:

\begin{equation}
\overrightarrow{N} = - \frac{\nabla F (x, y, z)}
                          {\abs{\nabla F(x, y, z)}} \cdot
  \textrm{sign}(n) \cdot
  \textrm{sign}\left(\frac{\partial F}{\partial z}(x, y, z)\right)
\end{equation}

\subsection{Sphere altitude formulation and first derivatives}
We formulate the sphere altitude in the $z = f(x, y)$ form. This form
is useful for hand calculations, plots, etc. We follow by deriving the
first derivatives in $x$ and $y$.

\paragraph{altitude}
The complete sphere is described by

\begin{equation}
\begin{split}
& x^2 + y^2 + (z - R)^2 = R^2 \\
\iff & (z - R)^2 = R^2 - x^2 - y^2 \\
\iff & \abs{z-R} = \sqrt{R^2 - x^2 - y^2}
\end{split} \end{equation}

Now, we consider only the first hemisphere $(\abs{z} < \abs{R})$, so
there are two cases depending on the sign of $R$. Moreover, by definition,
the sign of $z$ is the same as that of $R$.

\begin{equation} \begin{cases}
\abs{z - R} = -z + R & R \geq 0 \\
\abs{z - R} = z - R & R < 0
\end{cases} \end{equation}

For the $R \geq 0$ case, we have:

\begin{equation} \begin{split}
& R - z = \sqrt{R^2 -x^2 -y^2} \\
\iff & z = R \left( 1 - \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{split} \end{equation}

For the $R < 0$ case, we have:

\begin{equation} \begin{split}
& z - R = \sqrt{R^2 -x^2 -y^2} \\
\iff & z = R \left( 1 - \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{split} \end{equation}

The two cases can be reunited in the following formula, which is the
analytic expression of the sphere shape in our program \cref{eq:sphere-alt}.

\begin{equation} \label{eq:sphere-alt}
z = R \left( 1 - \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right)
\end{equation}

\paragraph{derivatives}
We compute the partial derivative with respect to $x$ of \cref{eq:sphere-alt}.

\begin{equation} \begin{split}
\frac{\partial z}{\partial x} & = 
\frac{\partial}{\partial x}
\left( -R \cdot \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right) \\
& = - R \cdot \frac{\partial}{\partial x}
\left( \sqrt{1 - \frac{x^2 + y^2}{R^2}} \right) \\
& = R \cdot \frac{1}{\sqrt{1 - \frac{x^2 + y^2}{R^2}}} \cdot
\frac{x}{R^2} \\
& = \frac{x}{R \cdot \sqrt{1 - \frac{x^2 + y^2}{R^2}}} \\
& = \frac{\textrm{sign}(R) \cdot x}{\sqrt{R^2 - x^2 -y^2}}
\end{split} \end{equation}

By symmetry, we find the partial derivative with respect to $y$, both
formulae are in \cref{eq:sphere-derivatives}.

\begin{equation} \label{eq:sphere-derivatives} \begin{cases}
\frac{\partial z}{\partial x} (x, y) =
\frac{\textrm{sign}(R) \cdot x}{\sqrt{R^2 - x^2 -y^2}} \\
\frac{\partial z}{\partial y} (x, y) =
\frac{\textrm{sign}(R) \cdot y}{\sqrt{R^2 - x^2 -y^2}} \\
\end{cases} \end{equation}

\subsection{Sphere normal vector}
We derive an efficient expression for the normal vector of a sphere at
an intersection point. Keep in mind that we already know the intersection
point on the shape. We arrive at the result from two (slightly) different
starting points.

\subsubsection{Analytic formulation}
We plug the partial derivatives \cref{eq:sphere-derivatives} into the general
normal vector formula \cref{eq:gen-normal}.

\begin{equation} \begin{split}
\overrightarrow{N} & = \frac{\textrm{sign}(n)}
{\sqrt{1 + \frac{x^2}{R^2 - x^2 - y^2} + \frac{y^2}{R^2 - x^2 - y^2}}} \cdot
\begin{bmatrix}
\textrm{sign}(R) \cdot x \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
\textrm{sign}(R) \cdot y \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
-1
\end{bmatrix} \\
& = \frac{\textrm{sign}(n) \cdot \textrm{sign}(R) \cdot
          \sqrt{R^2 - x^2 - y^2}}
         {\sqrt{R^2 - x^2 - y^2 + x^2 + y^2}} \cdot
\begin{bmatrix}
x \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
y \mathbin{/} \sqrt{R^2 - x^2 - y^2} \\
-\textrm{sign}(R)
\end{bmatrix} \\
& = \frac{\textrm{sign}(R)}{\abs{R}} \cdot \textrm{sign}(n) \cdot
\begin{bmatrix}
x \\ y \\
- \textrm{sign}(R) \sqrt{R^2 - x^2 - y^2}
\end{bmatrix} \\
& = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix}
x \\ y \\
- \textrm{sign}(R) \sqrt{R^2 - x^2 - y^2}
\end{bmatrix}
\end{split} \end{equation}

With,

\begin{equation} \begin{cases}
\abs{z-R} = R - z & R \geq 0 \\
\abs{z-R} = z - R & R < 0
\end{cases} \end{equation}

Hence,

\begin{equation}
\abs{z-R} \cdot \textrm{sign}(R) = R - z
\end{equation}

Which leads us to the efficient expression for the sphere normal vector
\cref{eq:sphere-normal-anaformula}.

\begin{equation} \label{eq:sphere-normal-anaformula}
\overrightarrow{N} = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix}
x \\ y \\ z - R
\end{bmatrix}
\end{equation}

\subsubsection{Geometric formulation}
The center of the sphere is $C = (0, 0, R)$. We know the intersection point
$I = (x, y, z)$.

The normal vector to the sphere is colinear to $\overrightarrow{CI}$.

\begin{equation}
\overrightarrow{CI} = \begin{bmatrix} x \\ y \\ z - R \end{bmatrix}
\end{equation}

Now we obtain a vector $\overrightarrow{N_i}$ by flipping $\overrightarrow{CI}$
opposite to the incident ray in the $\hat{z}$ direction.

Remember that,

\begin{equation} \begin{cases}
z - R \leq 0 & R \geq 0 \\
z - R > 0 & R < 0
\end{cases} \end{equation}

so we have,

\begin{equation} \begin{cases}
\overrightarrow{N_i} = \textrm{sign}(n) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix} & R \geq 0 \\
\overrightarrow{N_i} = - \textrm{sign}(n) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix} & R < 0 \\
\end{cases} \end{equation}

Which can be summarized as,

\begin{equation}
\overrightarrow{N_i} = \textrm{sign}(n) \cdot \textrm{sign}(R) \cdot
\begin{bmatrix} x \\ y \\ z - R \end{bmatrix}
\end{equation}

Now, we simply normalize the vector in order to obtain $\overrightarrow{N}$.

\begin{equation} \begin{split}
\overrightarrow{N} &= \frac{\textrm{sign}(n) \cdot \textrm{sign}(R)}
{\sqrt{x^2 + y^2 + (z-R)^2}} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix} \\
&= \frac{\textrm{sign}(n) \cdot \textrm{sign}(R)}{\abs{R}} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix}
\end{split} \end{equation}

The efficient expression for $\overrightarrow{N}$ is given by
\cref{eq:sphere-normal-geoformula}.

\begin{equation} \label{eq:sphere-normal-geoformula}
\overrightarrow{N} = \frac{\textrm{sign}(n)}{R} \cdot
\begin{bmatrix} x \\ y \\ z - R\end{bmatrix}
\end{equation}

\subsection{Reflection formula derivation}
We derive the reflection formula. See the illustration \cref{fig:reflect}.
Let: \begin{itemize}
\item The surface normal $\overrightarrow{N}$ at the ray intersection.
\item The incident ray unit vector $\overrightarrow{i}$.
\item The reflected ray unit vector $\overrightarrow{r}$.
\item $\theta_i$ the (unsigned) angle between $\overrightarrow{N}$ and
      $\overrightarrow{i}$.
\item $\theta_r$ the (unsigned) angle between $\overrightarrow{N}$ and
      $\overrightarrow{r}$.
\end{itemize}

We want to compute $\overrightarrow{r}$ as a function of $\overrightarrow{i}$
and $\overrightarrow{N}$.  We assume the laws of reflection, which essentially
state that light behaves as a billiard ball in its geometrical interaction with
the surface.  We present several ways of looking at the problem. In our
opinion, these are not so much derivations as different restatements of the
laws of reflection.

\subsubsection{Bounce derivation}
The effect of the light bouncing off the surface can be stated in the following
fashion. The component of $\overrightarrow{i}$ colinear to $\overrightarrow{N}$
is inverted by the reflection. The other components of $\overrightarrow{i}$ stay
the same. This immediately gives the tractable relation.

\begin{equation}
\overrightarrow{r} = \overrightarrow{i} - 2 \cdot (\overrightarrow{N} \cdot
\overrightarrow{i}) \cdot \overrightarrow{N}
\end{equation}

\subsubsection{Geometric construction}
The ray reflection may be viewed as a geometric construction based on the
laws of reflection (see \cite{Glassner:1989} p.291 \cite{Comninos:2010}
p.335). We draw the geometric view of the problem on
\cref{fig:reflect-geometry}.

\begin{figure} \caption{\label{fig:reflect-geometry} Illustration for the
geometric construction of the reflect operation.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/reflect-geometry.svg}
\end{figure}

\subsubsection{Algebraic derivation}
We produce a derivation similar to the one included in \cite{Glassner:1989}
(p.131).

\begin{itemize}
\item The reflected ray is in the plane spanned by $\overrightarrow{i}$ and
      $\overrightarrow{N}$ (\emph{plane of incidence}).
\item $\theta_i = \theta_r$
\item Except in the degenerate case $\overrightarrow{i} = - \overrightarrow{N}$,
$\overrightarrow{r} \neq - \overrightarrow{i}$. Ie the reflected ray does not
retrace on the incident ray.
\end{itemize}

Translated algebraically, these statements suffice to determine a formula for
$\overrightarrow{r}$. Let $(\alpha, \beta)$ both in $\mathbb{R}$. The reflected
ray in the incidence plane must be expressed as:

\begin{equation}
\overrightarrow{r} = \alpha \cdot \overrightarrow{i} +
                     \beta \cdot \overrightarrow{N}
\end{equation}

We now add the remaining constraints on $\overrightarrow{r}$ in order to narrow
down expressions for $\alpha$ and $\beta$.

\begin{equation} \begin{split}
& \theta_i = \theta_r \\
\implies & \cos(\theta_i) = \cos(\theta_r) \\
\implies & - \overrightarrow{i} \cdot \overrightarrow{N} =
       \overrightarrow{N} \cdot \overrightarrow{r}
\end{split} \end{equation}

\begin{equation} \begin{split}
- \overrightarrow{i} \cdot \overrightarrow{N} &=
\overrightarrow{N} \cdot
(\alpha \cdot \overrightarrow{i} + \beta \cdot \overrightarrow{N}) \\
&= \alpha \cdot \overrightarrow{i} \cdot \overrightarrow{N} +
   \beta \cdot \overrightarrow{N} \cdot \overrightarrow{N} \\
&= \alpha \cdot \overrightarrow{N} \cdot \overrightarrow{i} + \beta
\end{split} \end{equation}

Hence the following expression for $\beta$.

\begin{equation} \label{eq:reflect-beta-expr}
\beta = - (\alpha + 1) \cdot \overrightarrow{N} \cdot \overrightarrow{i}
\end{equation}

Another constraint we exploit is that $\overrightarrow{r}$ is a unit vector.

\begin{equation} \begin{split}
& \abs{\overrightarrow{r}} = 1 \\
\implies& \abs{\alpha \cdot \overrightarrow{i} +
                \beta \cdot \overrightarrow{N}} = 1 \\
\implies& (\alpha \cdot i_x + \beta \cdot N_x)^2 +
          (\alpha \cdot i_y + \beta \cdot N_y)^2 +
          (\alpha \cdot i_z + \beta \cdot N_z)^2 = 1 \\
\implies& \alpha^2 ({i_x}^2 + {i_y}^2 + {i_z}^2) +
          \beta^2 ({N_x}^2 + {N_y}^2 + {N_z}^2) + \\
          &2 \cdot \alpha \cdot \beta 
          (i_x \cdot N_x + i_y \cdot N_y + i_z \cdot N_z) = 1 \\
\implies& \alpha^2 + \beta^2 + 2 \cdot \alpha \cdot \beta \cdot
          \overrightarrow{N} \cdot \overrightarrow{i} = 1
\end{split} \end{equation}

Now we plug the expression for $\beta$ \cref{eq:reflect-beta-expr}.

\begin{equation} \begin{split}
\implies& \alpha^2 + (\alpha + 1)^2
(\overrightarrow{N} \cdot \overrightarrow{i})^2
- 2 \cdot \alpha (\alpha + 1) \cdot
(\overrightarrow{N} \cdot \overrightarrow{i})^2 = 1 \\
\implies& \alpha^2 (1 - 2 (\overrightarrow{N} \cdot \overrightarrow{i})^2
+ (\overrightarrow{N} \cdot \overrightarrow{i})^2) + \\
& \alpha (-2\cdot (\overrightarrow{N} \cdot \overrightarrow{i})^2
        +2 \cdot (\overrightarrow{N} \cdot \overrightarrow{i})^2) +
(\overrightarrow{N} \cdot \overrightarrow{i})^2 = 1 \\
\implies& \alpha^2 \cdot (1 - (\overrightarrow{N} \cdot \overrightarrow{i})^2)
+ (\overrightarrow{N} \cdot \overrightarrow{i})^2 = 1 \\
\implies& \alpha^2 = \frac{1 - (\overrightarrow{N} \cdot \overrightarrow{i})^2}
                          {1 - (\overrightarrow{N} \cdot \overrightarrow{i})^2}
\end{split} \end{equation}

The degenerate case $\overrightarrow{i} = - \overrightarrow{N}$, which
leads to $1 - (\overrightarrow{N} \cdot \overrightarrow{i})^2 = 0$, is excluded.
The answer in the degenerate case is $\overrightarrow{r} = -
\overrightarrow{i}$. We continue the main derivation path with:

\begin{equation}
\alpha = \pm 1
\end{equation}

The case $\alpha = -1$ leads to $\beta = 0$ and $\overrightarrow{r} = -
\overrightarrow{i}$. We excluded this case by hypothesis.  The remaining answer
is $\alpha = + 1$.

Summarizing:

\begin{equation} \begin{cases}
\alpha = 1 \\
\beta = -2 \cdot \overrightarrow{N} \cdot \overrightarrow{i}
\end{cases} \end{equation}

This leads us to the expression for $\overrightarrow{r}$.

\begin{equation}
\overrightarrow{r} = \overrightarrow{i} - 2 \cdot (\overrightarrow{N} \cdot
\overrightarrow{i}) \cdot \overrightarrow{N}
\end{equation}

$\square$

\subsection{Refraction}
We derive the refraction formula vectorial form from the laws of refraction.
Then we check the equivalence of Bec's formula with the derived refraction
formula.

\subsubsection{Algebraic derivation}
We work through an algebraic derivation of the vectorial expression for
the refraction operation. Similar derivations may be found in
\cite{Glassner:1989} (p.288), originally by Whitted \cite{Whitted:2005}
and Heckbert \cite{Heckbert:1984}.

The quantities involved in the problem are (illustrated on
\cref{fig:refract-derivation}):

\begin{itemize}
\item $n_1$ the incident medium refraction index,
\item $n_2$ the output medium refraction index,
\item $\overrightarrow{i}$ the unit incident ray direction,
\item $\overrightarrow{N}$ the unit surface normal vector,
\item $\overrightarrow{t}$ the unit refracted ray direction,
\item $\theta_i$ the acute angle between $-\overrightarrow{i}$
and $\overrightarrow{N}$,
\item $\theta_t$ the angle between $-\overrightarrow{N}$ and
$\overrightarrow{t}$.
\end{itemize}

\cref{fig:refract-derivation}
\begin{figure} \caption{\label{fig:refract-derivation} Quantities involved
in the ray refraction operation.}
\includesvg[height=.2\textheight, width=.9\textwidth, keepaspectratio]
           {images/shape/refract-derivation.svg}
\end{figure}

We take for granted a number of assumptions related to the law of refraction
\cite{wiki:snell-refraction}:

\begin{itemize}
\item $\overrightarrow{t}$ is in the plane spanned by $\overrightarrow{i}$
and $\overrightarrow{N}$ (\emph{plane of incidence}),
\item Defining quadrants in the plane of incidence with respect to
$\overrightarrow{N}$ and the origin, $\overrightarrow{t}$ is in
the same quadrant as $\overrightarrow{i}$,
\item $n_1 \cdot \sin(\theta_i) = n_2 \cdot \sin(\theta_t)$
\item In the particular case where $-\overrightarrow{i} = \overrightarrow{N}$,
      the refracted ray is $\overrightarrow{t} = - \overrightarrow{N}$.
\end{itemize}

We remind some relations and define some shorthands used for conciseness.

\begin{equation} \begin{cases}
- \overrightarrow{N} \cdot \overrightarrow{i} = \cos(\theta_i) = c_i \\
- \overrightarrow{N} \cdot \overrightarrow{t} = \cos(\theta_t) = c_t \\
\sin(\theta_i) = s_i \\
\sin(\theta_t) = s_t \\
\frac{n_1}{n_2} = n_r
\end{cases} \end{equation}

Since $\overrightarrow{t}$ is in the incidence plane, it may be written as:

\begin{equation}
\overrightarrow{t} = \alpha \cdot \overrightarrow{i}
                     + \beta \cdot \overrightarrow{N}
\end{equation}

The other hypotheses provide the following constraints, which we will use
in order to solve for $\alpha$ and $\beta$.

\begin{equation} \begin{cases}
n_1 \cdot s_i = n_2 \cdot s_t \\
\abs{\overrightarrow{t}} = 1
\end{cases} \end{equation}

We may express a relation with the help of $c_t$:

\begin{equation} \begin{split}
c_t &= - \overrightarrow{N} \cdot \overrightarrow{t} \\
&= - \overrightarrow{N} \cdot
   (\alpha \cdot \overrightarrow{i} + \beta \cdot \overrightarrow{N}) \\
&= - \alpha \cdot \overrightarrow{N} \cdot \overrightarrow{i} - \beta \\
&= \alpha \cdot c_i - \beta
\end{split} \end{equation}

Thus,

\begin{equation}
\beta = \alpha \cdot c_i - c_t
\end{equation}

The $\overrightarrow{t}$ normalization constraint gives us another expression:

\begin{equation} \begin{split}
\abs{\overrightarrow{t}} &= \abs{\alpha \cdot \overrightarrow{i}
                                 + \beta \cdot \overrightarrow{N}} \\
&= (\alpha \cdot i_x + \beta \cdot N_x)^2 +
   (\alpha \cdot i_y + \beta \cdot N_y)^2 +
   (\alpha \cdot i_z + \beta \cdot N_z)^2 \\
&= \alpha^2 \cdot ({i_x}^2 + {i_y}^2 + {i_z}^2) +
   \beta^2 \cdot ({N_x}^2 + {N_y}^2 + {N_z}^2) + \\
   & 2 \cdot \alpha \cdot \beta \cdot
     (i_x \cdot N_x + i_y \cdot N_y + i_z \cdot N_z) \\
&= \alpha^2 + \beta^2 + 2 \cdot \alpha \cdot \beta \cdot \overrightarrow{i}
   \cdot \overrightarrow{N} \\
&= \alpha^2 + \beta^2 - 2 \cdot \alpha \cdot \beta \cdot c_i
\end{split} \end{equation}

Now we plug in the expression for $\beta$.

\begin{equation} \begin{split}
\abs{\overrightarrow{t}} &=
\alpha^2 + (\alpha \cdot c_i - c_t)^2 - 2 \cdot \alpha \cdot c_i \cdot
(\alpha \cdot c_i - c_t) \\
&= \alpha^2 + \alpha^2 \cdot {c_i}^2 + {c_t}^2
- 2 \cdot \alpha \cdot c_i \cdot c_t - 2 \cdot \alpha^2 \cdot {c_i}^2
+ 2 \cdot \alpha \cdot c_i \cdot c_t \\
&= \alpha^2 - \alpha^2 \cdot {c_i}^2 + {c_t}^2 \\
&= 1
\end{split} \end{equation}

Thus, making use of the Snell formula, and excluding the $c_i = 1$ case
for which the refracted ray is just $- \overrightarrow{N}$,

\begin{equation} \begin{split}
& \alpha^2 = \frac{1 - {c_t}^2}{1 - {c_i}^2} = \frac{{s_t}^2}{{s_i}^2} =
  {n_r}^2 \\
& \iff \alpha = \pm n_r
\end{split} \end{equation}

By the $\overrightarrow{t}$ quadrant hypothesis, the component along
$\overrightarrow{i}$ must be positive, hence $\alpha > 0 \implies \alpha = +
n_r$.

We have now solved for the scalar magnitudes of $\overrightarrow{t}$.

\begin{equation} \begin{cases}
\alpha = n_r \\
\beta = n_r \cdot c_i - c_t
\end{cases} \end{equation}

And $\overrightarrow{t}$ may be expressed as:

\begin{equation}
\overrightarrow{t} = n_r \cdot \overrightarrow{i}
 + (n_r \cdot c_i - c_t) \cdot \overrightarrow{N}
\end{equation}

All that is left is to express $c_t$ with respect to input problem quantities.
The case of \gls{TIR} appears when ${n_r}^2 \cdot {s_i}^2 > 1$ and is excluded
from the remainder of the derivation.

\begin{equation} \begin{split}
c_t &= \sqrt{1 - {s_t}^2} \\
&= \sqrt{1 - {n_r}^2 \cdot {s_i}^2} \\
&= \sqrt{1 - {n_r}^2 \cdot (1 - {c_i}^2)}
\end{split} \end{equation}

Thus the expression for $\overrightarrow{t}$ with respect to the problem's input
quantities is:

\begin{equation} \label{eq:refraction-derived}
\overrightarrow{t} = n_r \cdot \overrightarrow{i} -
\left(n_r \cdot \overrightarrow{N} \cdot \overrightarrow{i}
+ \sqrt{1 - {n_r}^2 \cdot \left(1 - 
             \left(\overrightarrow{N} \cdot \overrightarrow{i}\right)^2\right)}
\right)
\cdot \overrightarrow{N}
\end{equation}

$\square$

\subsubsection{Bec's formula validation}
We perform a check of Bec's formula's \cref{eq:bec-formula} validity with
respect to the derived refraction formula \cref{eq:refraction-derived}. Bec's
formula is expressed as:

\begin{equation}
\overrightarrow{t} = n_r \cdot \overrightarrow{i} +
(w - \sqrt{1 + c_{2m}}) \cdot \overrightarrow{N} 
\end{equation}

With:

\begin{equation} \begin{cases}
w &= - n_r \cdot \overrightarrow{i} \cdot \overrightarrow{N} \\
c_{2m} &= (w - n_r) \cdot (w + n_r)
\end{cases} \end{equation}

While the formula from our derivation is expressed as:

\begin{equation}
\overrightarrow{t} = n_r \cdot \overrightarrow{i} -
\left(n_r \cdot \overrightarrow{N} \cdot \overrightarrow{i}
+ \sqrt{1 - {n_r}^2 \cdot \left(1 - 
             \left(\overrightarrow{N} \cdot \overrightarrow{i}\right)^2\right)}
\right)
\cdot \overrightarrow{N}
\end{equation}

We may re-express it as:

\begin{equation}
\overrightarrow{t} = n_r \cdot \overrightarrow{i} +
\left(- n_r \cdot \overrightarrow{N} \cdot \overrightarrow{i}
- \sqrt{1 + \gamma} \right) \cdot \overrightarrow{N}
\end{equation}

We may check Bec's formula by proving that $\gamma = c_{2m}$.

\begin{equation} \begin{split}
c_{2m} &= (w - n_r) \cdot (w + n_r) = w^2 - {n_r}^2 \\
       &= {n_r}^2 \cdot
          \left( \overrightarrow{i} \cdot \overrightarrow{N} \right)^2
          - {n_r}^2 \\
       &= -{n_r}^2 \cdot
           \left(1 - \left(\overrightarrow{i} \cdot
                     \overrightarrow{N}\right)^2\right) \\
       &= \gamma
\end{split} \end{equation}

Thus we find Bec's formula to be mathematically equivalent to the refraction
formula we derived.

\subsection{transfer operation}
We work through the formula for applying the transfer operation to a ray.
We reuse the notations in the definition (\cref{sec:transfer}). The transfer
operation is the composition of a change of basis and an intersection with
the new local plane.

\paragraph{Change of basis}
The initial ray $(P_1, \overrightarrow{V_1})$ is expressed in LCS1 coordinates.
We express it in LCS2 with $(P_2, \overrightarrow{V_2})$. The LCS2 basis vectors
are obtained by a rotation of the LCS1 basis vectors. We express everything
in LCS1 coordinates up to the computation of $(P_2, \overrightarrow{V_2})$.

\begin{equation} \begin{cases}
\hat{x_2} = B \cdot \hat{x_1} \\
\hat{y_2} = B \cdot \hat{y_1} \\
\hat{z_2} = B \cdot \hat{z_1}
\end{cases} \end{equation}

The origin $A_2$ of LCS2 is obtained by a translation of $A_1$ along
the new, rotated, coordinates.

\begin{equation}
D = \begin{bmatrix} D_x \\ D_y \\ D_z \end{bmatrix}
\end{equation}

\begin{equation} \begin{split}
A_2 &= A_1 + D_x \cdot \hat{x_2} + D_y \cdot \hat{y_2} + D_z \cdot \hat{z_2} \\
    &= D_x \cdot \hat{x_2} + D_y \cdot \hat{y_2} + D_z \cdot \hat{z_2} \\
\end{split} \end{equation}

Let us remember the columns of $B$ are the basis vectors of LCS2 expressed
in LCS1.

\begin{equation}
B = \left[ \hat{x_2}, \hat{y_2}, \hat{z_2} \right]
\end{equation}

Thus, we can simplify the expression of $A_2$.

\begin{equation}
A_2 = B \cdot D
\end{equation}

The coordinates of $P_2$ are expressed thanks to a dot product with the basis
vectors of LCS2.

\begin{equation} \begin{cases}
x_2 = (P - A_2) \cdot \hat{x_2} \\
y_2 = (P - A_2) \cdot \hat{y_2} \\
z_2 = (P - A_2) \cdot \hat{z_2}
\end{cases} \end{equation}

Again, this can be viewed as the following matrix-vector multiplication.

\begin{equation} \begin{split}
P_2 &= B^\top \cdot (P - A_2) \\
    &= B^\top \cdot (P - B \cdot D) \\
    &= B^\top \cdot P - D
\end{split} \end{equation}

Similarly, $\overrightarrow{V_2}$ may be expressed in LCS2.

\begin{equation} \begin{cases}
l_2 = \overrightarrow{V_1} \cdot \hat{x_2} \\
m_2 = \overrightarrow{V_1} \cdot \hat{y_2} \\
n_2 = \overrightarrow{V_1} \cdot \hat{z_2}
\end{cases} \end{equation}

Which can be simplified as the following relation.

\begin{equation}
\overrightarrow{V_2} = B^\top \cdot \overrightarrow{V_1}
\end{equation}

\paragraph{Intersection with the new local plane}
The ray characterized by $(P_2, \overrightarrow{V_2}$ is intersected
with the LCS2 $z = 0$ plane. Every operation happens in LCS2 coordinates.
The intersection condition between the ray parametrized by $t$ and the
plane is expressed as follows.

\begin{equation}
z_2 + t \cdot n_2 = 0
\end{equation}

We treat the case $n_2 = 0$ as an error case. It corresponds to the ray
being parallel to the plane.

\begin{equation}
t = - \frac{z_2}{n_2}
\end{equation}

We simply propagate point $P_2$ up to the intersection $P_3$.

\begin{equation}
P_3 = \begin{bmatrix}
x_2 + t \cdot l_2 \\
y_2 + t \cdot m_2 \\
0
\end{bmatrix}
\end{equation}

The ray vector $\overrightarrow{V_2}$ does not undergo any operation, hence
$\overrightarrow{V_3} = \overrightarrow{V_2}$.

\subsection{standard shape}
The \lstinline{standard} shape is defined with the formula in
\cref{eq:standard-z}. This formula may be found in \cite{Welford:1986}
(section 4.7) and in \cite{Greynolds:2002} \footnote{Note the use of this kind
of surface in optics dates back to at least Kepler in this present form and all
the way back to the Greeks for the general idea.}.  We explore its link with
quadrics and try to provide a rationale for how it was defined from quadrics.

Note we freely convert between $R$ and $c$, and $r$ and $(x, y)$ in
the derivations.

\subsubsection{Range of definition}
The range in $r$ for which the \lstinline{standard} shape is defined
depends on $k$. The shape is defined when,

\begin{equation} \begin{split}
& 1 - (k+1) \cdot c^2 \cdot r^2 \geq 0 \\
\iff & (k+1) \cdot c^2 \cdot r^2 \leq 1
\end{split} \end{equation}

For $k \leq -1$, the validity condition is met for $r \in \mathbb{R}$.
For $k > -1$, the condition is met when,

\begin{equation} \begin{split}
& r^2 \leq \frac{1}{c^2 \cdot (k+1)} \\
\iff & r \leq \frac{\abs{R}}{\sqrt{k+1}}
\end{split} \end{equation}

\subsubsection{Link with quadrics}
We exhibit the link between the \lstinline{standard} surface and the
more general quadrics expressions.

\paragraph{General quadrics form}
An expression for general quadrics can be written as \cite{wiki:quadric}.

\begin{equation}
A x^2 + B y^2 + C z^2 + D x y + E y z + F x z + G x + H y + I z + J = 0
\end{equation}

With,
\begin{itemize}
\item $A, B, C, D, E, F, G, H, I, J$ all in $\mathbb{R}$,
\item At least one of $A$, $B$ or $C$ is non-zero.
\end{itemize}

We can easily see to which family of quadrics the points defined by the
\lstinline{standard} altitude formula \emph{belong to}. We start with
the altitude expression and re-express it in the general quadrics form.

\begin{equation} \begin{split}
&z = \frac{c \cdot r^2}{1 + \sqrt{1 - (k + 1) \cdot c^2 \cdot r^2}} \\
\implies & z + z \cdot \sqrt{1 - (k+1) \cdot c^2 \cdot r^2} = c \cdot r^2 \\
\implies & z - c \cdot r^2 = - z \cdot \sqrt{1 - (k + 1) \cdot c^2 \cdot r^2} \\
\implies & \frac{c \cdot r^2}{z} - 1 = \sqrt{1 - (k + 1) \cdot c^2 \cdot r^2} \\
\implies & \frac{c^2 \cdot r^4}{z^2} + 1 - \frac{2 \cdot c \cdot r^2}{z} =
           1 - (k + 1) \cdot c^2 \cdot r^2 \\
\implies & \frac{c \cdot r^2}{z^2} - \frac{2}{z} = - (k + 1) \cdot c \\
\implies & (k + 1) \cdot z^2 - \frac{2}{c} \cdot z + r^2 = 0 \\
\implies & x^2 + y^2 + (k + 1) \cdot z^2 - 2 R \cdot z = 0
\end{split} \end{equation}

We readily see this quadric can be defined from the general quadric expression
by setting:

\begin{equation} \begin{cases}
A = B = 1 \\
C = k + 1 \\
I = -2 R \\
D = E = F = G = H = J = 0
\end{cases} \end{equation}

\paragraph{Normal form}
We operate the suitable change of coordinates in order to reduce the quadric
expression to a so-called \emph{normal form} (\cite{wiki:quadric},
\cite{Venit:2008} p.384) and better identify the types of quadrics we are
working with.

First, we treat the case $k=-1$.
The quadric takes the following form.

\begin{equation} \begin{split}
&x^2 + y^2 - 2 R \cdot z = 0 \\
\iff &z = \frac{c}{2} \cdot x^2 + \frac{c}{2} \cdot y^2
\end{split} \end{equation}

This form is a \emph{circular paraboloid}.

Then, we treat the case $k \neq -1$. Let $k' = k + 1$.

\begin{equation} \begin{split}
& x^2 + y^2 + k' \cdot z^2 - 2 R \cdot z = 0 \\
\iff & x^2 + y^2 + k' \cdot \left( z^2 - \frac{2R}{k'} \cdot z\right) = 0 \\
\iff & x^2 + y^2 + k' \cdot \left( z - \frac{R}{k'} \right)^2 - \frac{R^2}{k'}
       = 0
\end{split} \end{equation}

We operate the change of coordinate $z' = z - \frac{R}{k'}$.

\begin{equation} \begin{split}
& x^2 + y^2 + k' \cdot z'^2 - \frac{R^2}{k'} = 0 \\
\iff & x^2 \cdot \frac{k'}{R^2} + y^2 \cdot \frac{k'}{R^2} +
       z'^2 \cdot \frac{k'^2}{R^2} - 1 = 0 \\
\iff & x^2 \cdot \frac{\textrm{sign}(k') \cdot \abs{k'}}{R^2} +
       y^2 \cdot \frac{\textrm{sign}(k') \cdot \abs{k'}}{R^2} +
       z'^2 \cdot \frac{k'^2}{R^2} - 1 = 0 \\
\iff & x^2 \cdot \frac{\abs{k'}}{R^2} + y^2 \cdot \frac{\abs{k'}}{R^2} +
       z'^2 \cdot \textrm{sign}(k') \cdot \frac{k'^2}{R^2} - \textrm{sign}(k')
       = 0
\end{split} \end{equation}

Let,
\begin{equation} \begin{cases}
a^2 = \frac{R^2}{\abs{k'}} \\
b^2 = \frac{R^2}{k'^2} \\
\epsilon = \textrm{sign}(k')
\end{cases} \end{equation}

A readable \emph{normal form} is:

\begin{equation}
\frac{x^2}{a^2} + \frac{y^2}{a^2} + \epsilon \cdot \frac{z'^2}{b^2} - \epsilon
  = 0
\end{equation}

The case $k < -1$ gives the form,

\begin{equation}
\frac{x^2}{a^2} + \frac{y^2}{a^2} - \frac{z'^2}{b^2} = -1
\end{equation}

which is a \emph{hyperboloid of revolution of two sheets}.

The case $k > -1$ gives the form,

\begin{equation}
\frac{x^2}{a^2} + \frac{y^2}{a^2} + \frac{z'^2}{b^2} = 1
\end{equation}

which is a \emph{spheroid}.

\subsubsection{Rationale for defining the shape from quadrics}
We explore the rationale which leads from the general quadric (with potentially
two sheets) to the \lstinline{standard} altitude definition.

The general quadric is defined as,

\begin{equation}
x^2 + y^2 + (k+1) \cdot z^2 - 2 R \cdot z = 0
\end{equation}

We solve for $z$.

In the $k=-1$ case, the quadric is a circular paraboloid and has a single
sheet, thus the solution is unambiguous.

\begin{equation}
z = \frac{c \cdot r^2}{2}
\end{equation}

In the $k\neq-1$ cases, the solution is given by solving the quadratic equation.

\begin{equation} \begin{cases}
\Delta = 4 R^2 - 4 (k+1) \cdot r^2 \\
z = \frac{2R \pm \sqrt{\Delta}}{2(k+1)}
\end{cases} \end{equation}

We have two solutions given by,

\begin{equation}
z = \frac{R \pm \sqrt{R^2 - (k+1) \cdot r^2}}{k + 1}
\end{equation}

These define the two sheets of the spheroid or the hyperboloid of revolution of
two sheets. We need to define only a single sheet for the purpose of optical
design raytracing. We choose to have $z(r=0) = 0$.

\begin{equation} \begin{split}
& z(r=0) = 0 \\
\iff & \frac{R \pm \sqrt{R^2}}{k+1} = 0 \\
\iff & R \pm \abs{R} = 0
\end{split} \end{equation}

We have to distinguish cases based on the sign of $R$.
\begin{itemize}
\item $R \geq 0$: we choose the solution with minus sign in order to constrain
                  $z(r=0)=0$,
\item $R < 0$: we choose the solution with plus sign.
\end{itemize}

Therefore, we build our solution as:
\begin{equation} \begin{split}
& z = \frac{R - \textrm{sign}(R) \cdot \sqrt{R^2 - (k+1) \cdot r^2}}{k+1} \\
\iff & (k+1) \cdot z = R - \textrm{sign}(R) \cdot \sqrt{R^2 - (k+1) \cdot r^2}\\
\iff & (k+1) \cdot z \cdot \left( R + \textrm{sign}(R) \cdot
       \sqrt{R^2 - (k+1) \cdot r^2} \right) = R^2 - (R^2 - (k+1) \cdot r^2) \\
\iff & z \cdot \left( R + \textrm{sign}(R) \cdot
       \sqrt{R^2 - (k+1) \cdot r^2} \right) = r^2 \\
\iff & z = \frac{r^2}{R + \textrm{sign}(R) \cdot \sqrt{R^2 - (k+1) \cdot r^2}}\\
\iff & z = \frac{r^2}{R + \textrm{sign}(R) \cdot \abs{R} \cdot
                      \sqrt{1 - (k+1) \cdot r^2 \cdot c^2}} \\
\iff & z = \frac{c \cdot r^2}{1 + \sqrt{1 - (k+1) \cdot r^2 \cdot c^2}}
\end{split} \end{equation}

Which is the \lstinline{standard} altitude formula in use. We see the $k=-1$
case is still compatible with this formula.

\subsubsection{Intersection formula}
The intersection of a ray with a \lstinline{standard} shape may be expressed
in closed-form. Finding it involves substituting the usual ray equation in
the \lstinline{standard} surface expression.

The ray equation being, as usual,

\begin{equation}
\begin{bmatrix} x \\ y \\ z \end{bmatrix} =
\begin{bmatrix} x_P \\ y_P \\ 0 \end{bmatrix} + t \cdot
\begin{bmatrix} l \\ m \\ n \end{bmatrix}
\end{equation}

and we can use either \lstinline{standard} surface expressions, both giving
rise to a quadratic equation during the solving process.

\begin{equation} \begin{cases}
z = \frac{c \cdot r^2}{1 + \sqrt{1 - (k+1) \cdot c^2 \cdot r^2}} \\
x^2 + y^2 + (k+1) \cdot z^2 - 2R \cdot z = 0
\end{cases} \end{equation}

Finding the expression for solutions is easy, but finding an expression which
is numerically well behaved is more involved. Thankfully, Welford found such
an expression \cite{Welford:1986}, which we use with a slight modification.

\begin{equation} \begin{cases}
f = c \cdot ({x_P}^2 + {y_P}^2) \\
g = n - c \cdot (l \cdot x_P + m \cdot y_P) \\
t = \frac{f}{g + \textrm{sign}(n) \cdot
             \sqrt{g^2 - c \cdot f \cdot (1 + k \cdot n^2)}}
\end{cases} \end{equation}

Our minor modification is the addition of $\textrm{sign}(n)$ which allows
choosing the right root regardless of ray orientation.

The case where $g^2 - c \cdot f \cdot (1 + k \cdot n^2) \leq 0$ corresponds
to an error case of absence of intersection or ray tangency.

In non-error cases, the intersection point is given as usual with:

\begin{equation}
I = P + t \cdot V
\end{equation}

Note there is no possibility with this expression of finding an intersection
beyond the first hemisphere in the case of spheroids. The hand validation being
laborious, we validated the intersection formula with a symbolic math tool.

\subsubsection{Normal vector}
The normal vector at some point on the surface is found by computing the
gradient of the implicit quadric expression, this is the method followed by
Welford \cite{Welford:1986}.

Let $\varepsilon = k+1$, the implicit quadric expression is:

\begin{equation}
F(x,y,z) = \frac{c}{2} \cdot (x^2 + y^2 + \varepsilon \cdot z^2) - z = 0
\end{equation}

We compute the gradient:

\begin{equation} \begin{cases}
\frac{\partial F}{\partial x} = c \cdot x\\
\frac{\partial F}{\partial y} = c \cdot y\\
\frac{\partial F}{\partial z} = c \cdot \varepsilon \cdot z - 1\\
\end{cases} \end{equation}

The norm of the unit vector is then,

\begin{equation}
\abs{\overrightarrow{N}} =
\sqrt{c^2 \cdot (x^2 + y^2) + c^2 \cdot \varepsilon^2
  \cdot z^2 + 1 - 2 c \cdot \varepsilon \cdot z} \\
\end{equation}

We know from the quadric expression that,

\begin{equation}
x^2 + y^2 = \frac{2}{c} \cdot z - \varepsilon \cdot z^2
\end{equation}

Hence,

\begin{equation} \begin{split}
\abs{\overrightarrow{N}} &=
\sqrt{c^2 \cdot \left( \frac{2}{c} \cdot z - \varepsilon \cdot z^2 \right)
  + c^2 \cdot \varepsilon^2 \cdot z^2 + 1 - 2 c \cdot \varepsilon \cdot z} \\
&= \sqrt{1 - 2 c \cdot (\varepsilon - 1) \cdot z + c^2 \cdot \varepsilon \cdot
         (\varepsilon - 1) \cdot z^2}
\end{split} \end{equation}

The unit vector with correct orientation is then:

\begin{equation}
\overrightarrow{N} = -
\begin{bmatrix}
c \cdot x \\ c \cdot y \\ c \cdot \varepsilon \cdot z - 1
\end{bmatrix} \cdot
\frac{\textrm{sign}(n) \cdot \textrm{sign}(c \cdot \varepsilon \cdot z - 1)}
{\abs{\overrightarrow{N}}}
\end{equation}

\textcolor{red}{TODO: simplify the sign of df/dz, I think it is always the same
due to the validity range of the surface.}
